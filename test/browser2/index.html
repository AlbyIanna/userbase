<!DOCTYPE html>
<html lang="en">

<head>
  <script type="text/javascript" src="./tmp/userbase.js"></script>
  <script src="./tmp/loginInfo.js"></script>
  <script src="./tmp/development.js"></script>
</head>

<body>
  <h1>Browser 2</h1>
  <h4>Open up the web console and preserve logs!</h4>
</body>

<script>
  const test1 = () => {
    console.log('%cTest 1: Browser 1 waits for Browser 2 to insert', 'font-size: large')

    const { username, password } = USERS[0]

    userbase.init({ appId, endpoint })

    userbase.signIn(username, password)
      .then(() => {
        console.log('Signed in...')

        userbase.openDatabase(dbName, () => { })
          .then(() => {
            userbase.insertItem(dbName, 'Hello world!', 'test-id')
              .then(() => completedTest(1))
          })
          .catch((e) => console.assert(false, e))

      })
      .catch((e) => console.assert(false, e))
  }

  const test2 = () => {
    console.log('%cTest 2: Browser 1 waits for Browser 2 to Insert 10 items concurrently', 'font-size: large')

    const NUM_INSERTS = 10

    const { username, password } = USERS[1]

    userbase.init({ appId, endpoint })

    userbase.signIn(username, password)
      .then(() => {
        console.log('Signed in...')

        userbase.openDatabase(dbName, () => { })
          .then(() => {

            for (let i = 0; i < NUM_INSERTS; i++) {
              userbase.insertItem(dbName, 'item-' + i, i.toString())
            }

            completedTest(2)
          })
          .catch((e) => console.assert(false, e))

      })
      .catch((e) => console.assert(false, e))
  }

  const test3 = () => {
    console.log('%cTest 3: Browser 1 & Browser 2 each Insert 10 items concurrently', 'font-size: large')

    const NUM_INSERTS = 10

    const { username, password } = USERS[2]

    userbase.init({ appId, endpoint })

    userbase.signIn(username, password)
      .then((user) => {
        console.log('Signed in...')

        userbase.openDatabase(dbName, () => { })
          .then(() => {

            // wait until timeToInsert
            const timeToWait = Number(user.profile.timeToInsert) - Date.now()
            assert(timeToWait > 0, true, 'Must wait a positive amount of time to insert')

            wait(timeToWait)
              .then(() => {
                console.log('Inserting all items at ' + new Date())

                for (let i = 0; i < NUM_INSERTS; i++) {
                  userbase.insertItem(dbName, 'item-' + (i + NUM_INSERTS), (i + NUM_INSERTS).toString())
                }

                completedTest(3)
              })

          })
          .catch((e) => console.assert(false, e))

      })
      .catch((e) => console.assert(false, e))
  }

  const test4 = () => {
    console.log('%cTest 4: Browser 1 & Browser 2 each Insert the same batch of 20 items concurrently', 'font-size: large')

    const NUM_INSERTS = 20

    userbase.init({ appId, endpoint })

    const { username, password } = USERS[3]

    userbase.signIn(username, password)
      .then((user) => {
        console.log('Signed in...')

        let database = []

        userbase.openDatabase(dbName, (items) => { database = items })
          .then(() => {

            // wait until timeToInsert
            const timeToWait = Number(user.profile.timeToInsert) - Date.now()
            assert(timeToWait > 0, true, 'Must wait a positive amount of time to insert')

            wait(timeToWait)
              .then(() => {
                console.log('Inserting all items at ' + new Date())

                const inserts = []

                for (let i = 0; i < NUM_INSERTS; i++) {
                  const item = {
                    browser: 2,
                    i
                  }

                  const insert = new Promise(resolve => {
                    userbase.insertItem(dbName, item, i.toString())
                      .then(() => {
                        console.log(`Item with id ${i.toString()} succeeeded!`)
                        resolve()
                      })
                      .catch((e) => {
                        assert(e.name, 'ItemAlreadyExists', 'error name')
                        assert(e.message, 'Item with the same id already exists.', 'error message')
                        assert(e.status, 409, 'error status')
                        resolve()
                      })
                  })

                  inserts.push(insert)
                }

                Promise.all(inserts)
                  .then(() => {
                    console.log("Final State after this browser's inserts completed: ", JSON.stringify(database))
                    completedTest(4)
                  })
              })
          })
          .catch((e) => console.assert(false, e))
      })
      .catch((e) => console.assert(false, e))
  }

  if (!location.hash) console.log('%cBrowser 2', 'font-size: x-large; font-weight: bold;')

  // wait for other browser to sign up account
  wait(5000)
    .then(() => {
      switch (location.hash) {
        case '':
          test1()
          break

        case '#test2':
          test2()
          break

        case '#test3':
          test3()
          break

        case '#test4':
          test4()
          break

        case '#complete':
          console.log('%cTests complete!', 'color: green; font-size: large;')
          break

        default:
          location.hash = 'complete'
          location.reload()
          break
      }
    })

</script>

</html>
