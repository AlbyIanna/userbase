<!DOCTYPE html>
<html lang="en">

<head>
  <title>Ugliest To-Do App</title>
  <script type="text/javascript" src="https://userbase-public.s3-us-west-2.amazonaws.com/userbase-js/userbase.js"></script>
  <script type="text/javascript">
    userbase.configure({ appId: 'a43ae910-fc89-43fe-a7a3-a11a53b49325' })
  </script>
</head>

<body>
  <!-- Login / New Account Panel -->
  <div id="account-form">
    <div>
      <h1>Login</h1>
      <form onsubmit="login(event)">
        <input id="login-email" type="email" required placeholder="Email">
        <input id="login-password" type="password" required placeholder="Password">
        <input type="submit" value="Login">
      </form>
      <div id="login-error"></div>
    </div>

    <div>
      <h1>Create Account</h1>
      <form onsubmit="createAccount(event)">
        <input id="create-email" type="email" required placeholder="Email">
        <input id="create-password" type="password" required placeholder="Password">
        <input type="submit" value="Create Account">
      </form>
      <div id="create-error"></div>
    </div>
  </div>

  <!-- To-do List -->
  <div id="todo-list">
    <div>
      <label id="email"></label>
      <input type="button" value="Logout" onclick="logout()">
      <div id="logout-error"></div>
    </div>

    <h1>To-dos</h1>

    <div id="todos"></div>

    <form onsubmit="addTodo(event)">
      <input id="new-todo" type="text" required placeholder="New to-do">
      <input type="submit" value="Add">
    </form>
    <div id="add-todo-error"></div>
  </div>

  <script type="text/javascript">
    // hide everything initially
    document.getElementById('account-form').style.display = 'none'
    document.getElementById('todo-list').style.display = 'none'

    // check if there's an existing session cookie, and validate it
    userbase.signInWithSession()
      .then((session) => openTodoList(session))

    // login handler
    function login(e) {
      preventFormSubmit(e)

      const username = document.getElementById('login-email').value
      const password = document.getElementById('login-password').value

      userbase.signIn(username, password)
        .then((session) => openTodoList(session))
        .catch((e) => document.getElementById('login-error').innerHTML = e)
    }

    // new account handler
    function createAccount(e) {
      preventFormSubmit(e)

      const username = document.getElementById('create-email').value
      const password = document.getElementById('create-password').value

      userbase.signUp(username, password)
        .then((session) => openTodoList(session))
        .catch((e) => document.getElementById('create-error').innerHTML = e)
    }

    // logout handler
    function logout() {
      userbase.signOut()
        .then(() => {
          document.getElementById('account-form').style.display = 'block'
          document.getElementById('todo-list').style.display = 'none'
        })
        .catch((e) => document.getElementById('logout-error').innerHTML = e)
    }

    // add a to-do item handler
    function addTodo(e) {
      preventFormSubmit(e)

      const todo = document.getElementById('new-todo').value

      userbase.insert('todos', { 'todo': todo }, Date.now())
        .then(() => document.getElementById('new-todo').value = '')
        .catch((e) => document.getElementById('add-todo-error').innerHTML = e)
    }

    // this renders the to-do list whenever the database gets updated
    function databaseChange(items) {
      const todosList = document.getElementById('todos')

      // clear the list
      todosList.innerHTML = ''

      // render all the to-do items
      for (let i = 0; i < items.length; i++) {

        // build the todo delete button
        const todoDelete = document.createElement('button')
        todoDelete.innerHTML = 'X'
        todoDelete.style.display = 'inline-block'
        todoDelete.onclick = () => {
          userbase.delete('todos', items[i].itemId)
            .catch((e) => document.getElementById('add-todo-error').innerHTML = e)
        }

        // build the todo checkbox
        const todoBox = document.createElement('input')
        todoBox.type = 'checkbox'
        todoBox.id = items[i].itemId
        todoBox.checked = items[i].record.complete ? true : false
        todoBox.onclick = (e) => {
          e.preventDefault()

          userbase.update('todos', items[i].itemId, { 'todo': items[i].record.todo, 'complete': !items[i].record.complete })
            .catch((e) => document.getElementById('add-todo-error').innerHTML = e)
        }

        // build the todo label
        const todoLabel = document.createElement('label')
        todoLabel.innerHTML = items[i].record.todo
        todoLabel.style.textDecoration = items[i].record.complete ? 'line-through' : 'none'

        // append the todo item to the list
        const todoItem = document.createElement('div')
        todoItem.appendChild(todoDelete)
        todoItem.appendChild(todoBox)
        todoItem.appendChild(todoLabel)
        todosList.appendChild(todoItem)
      }
    }

    // shows the to-do list and starts listenting to database changes
    function openTodoList(session) {
      if (!session || !session.signedIn) {
        // if user is not logged in, show the login / new account form
        document.getElementById('account-form').style.display = 'block'
        document.getElementById('todo-list').style.display = 'none'
        return
      }

      openDatabase(session)
    }

    // opens the database and listens to changes
    function openDatabase(session) {
      // set the database change listener
      userbase.openDatabase('todos', databaseChange)
        .then(() => {
          // show the todo list once the database is open, and clear everything else
          document.getElementById('email').innerHTML = session.username
          document.getElementById('account-form').style.display = 'none'
          document.getElementById('todo-list').style.display = 'block'
          document.getElementById('login-email').value = ''
          document.getElementById('login-password').value = ''
          document.getElementById('create-email').value = ''
          document.getElementById('create-password').value = ''
          document.getElementById('create-error').innerHTML = ''
          document.getElementById('login-error').innerHTML = ''
          document.getElementById('new-todo').focus()
        })
        .catch((e) => {
          document.getElementById('create-error').innerHTML = e
        })
    }

    function preventFormSubmit(e) {
      e.preventDefault()
      if (window.history.replaceState) window.history.replaceState(null, null, window.location.href);
    }

  </script>
</body>
