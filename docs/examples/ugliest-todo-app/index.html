<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Ugliest To-Do App</title>
    <script type="text/javascript" src="https://userbase-public.s3-us-west-2.amazonaws.com/userbase-js/userbase.js"></script>
    <script type="text/javascript">
      userbase.configure({ appId: 'a43ae910-fc89-43fe-a7a3-a11a53b49325' })
    </script>
  </head>

  <body>
    <!-- Init View -->
    <div id="init-view">Signing you in...</div>

    <!-- Auth View -->
    <div id="auth-view">
      <h1>Login</h1>
      <form id="login-form"> 
        <input id="login-username" type="email" required placeholder="Email">
        <input id="login-password" type="password" required placeholder="Password">
        <input type="submit" value="Sign in">
      </form>
      <div id="login-error"></div>

      <h1>Create an account</h1>
      <form id="create-account-form">
        <input id="create-account-username" type="email" required placeholder="Email">
        <input id="create-account-password" type="password" required placeholder="Password">
        <input type="submit" value="Create an account">
      </form>
      <div id="create-account-error"></div>
    </div>

    <!-- To-dos View -->
    <div id="todo-view">
      <div id="username"></div>
      <input type="button" value="Logout" id="logout-button">
      <div id="logout-error"></div>

      <h1>To-Do List</h1>
      <div id="todos"></div>
      <div id="db-loading">Loading to-dos...</div>
      <div id="db-error"></div>

      <form id="add-todo-form"> 
        <input id="add-todo" type="text" required placeholder="To-Do">
        <input type="submit" value="Add">
      </form>
      <div id="add-todo-error"></div>
    </div>

    <!-- application code -->
    <script type="text/javascript">
      function handleLogin(e) {
        e.preventDefault()

        const username = document.getElementById('login-username').value
        const password = document.getElementById('login-password').value

        userbase.signIn(username, password)
          .then((session) => showTodos(session.username))
          .catch((e) => document.getElementById('login-error').innerHTML = e)
      }

      function handleCreateAccount(e) {
        e.preventDefault() 

        const username = document.getElementById('create-account-username').value
        const password = document.getElementById('create-account-password').value

        userbase.signUp(username, password)
          .then((session) => showTodos(session.username))
          .catch((e) => document.getElementById('create-account-error').innerHTML = e)
      }

      function handleLogout() {
        userbase.signOut()
          .then(() => showAuth())
          .catch((e) => document.getElementById('logout-error').innerText = e)
      }

      function showTodos(username) {
        document.getElementById('auth-view').style.display = 'none'
        document.getElementById('todo-view').style.display = 'block'
        
        // reset the todos view
        document.getElementById('username').innerHTML = username
        document.getElementById('db-loading').style.display = 'block'
        document.getElementById('db-error').innerText = ''

        userbase.openDatabase('todos', handleDatabaseChange)
          .then(() => {
            document.getElementById('db-loading').style.display = 'none'
          })
          .catch((e) => {
            document.getElementById('db-loading').style.display = 'none'
            document.getElementById('db-error').innerText = e
          })
      }

      function showAuth() {
        document.getElementById('todo-view').style.display = 'none'
        document.getElementById('auth-view').style.display = 'block'
        document.getElementById('login-username').value = ''
        document.getElementById('login-password').value = ''
        document.getElementById('login-error').innerText = ''
        document.getElementById('create-account-username').value = ''
        document.getElementById('create-account-password').value = ''
        document.getElementById('create-account-error').innerText = ''
      }

      function handleDatabaseChange(items) {
        const todosList = document.getElementById('todos')

        if (items.length === 0) {
          todosList.innerText = "Empty."
        } else {
          // clear the list
          todosList.innerHTML = ''

          // render all the to-do items
          for (let i = 0; i < items.length; i++) {

            // build the todo delete button
            const todoDelete = document.createElement('button')
            todoDelete.innerHTML = 'X'
            todoDelete.style.display = 'inline-block'
            todoDelete.onclick = () => {
              userbase.delete('todos', items[i].itemId)
                .catch((e) => document.getElementById('db-error').innerHTML = e)
            }

            // build the todo checkbox
            const todoBox = document.createElement('input')
            todoBox.type = 'checkbox'
            todoBox.id = items[i].itemId
            todoBox.checked = items[i].record.complete ? true : false
            todoBox.onclick = (e) => {
              e.preventDefault()
              userbase.update('todos', { 'todo': items[i].record.todo, 'complete': !items[i].record.complete }, items[i].itemId)
                .catch((e) => document.getElementById('db-error').innerHTML = e)
            }

            // build the todo label
            const todoLabel = document.createElement('label')
            todoLabel.innerHTML = items[i].record.todo
            todoLabel.style.textDecoration = items[i].record.complete ? 'line-through' : 'none'

            // append the todo item to the list
            const todoItem = document.createElement('div')
            todoItem.appendChild(todoDelete)
            todoItem.appendChild(todoBox)
            todoItem.appendChild(todoLabel)
            todosList.appendChild(todoItem)
          }
        }
      }      

      function addTodoHandler(e) {
        e.preventDefault()

        const todo = document.getElementById('add-todo').value

        userbase.insert('todos', { 'todo': todo }, Date.now())
          .then(() => document.getElementById('add-todo').value = '')
          .catch((e) => document.getElementById('add-todo-error').innerHTML = e)
      }

      document.getElementById('login-form').addEventListener('submit', handleLogin)
      document.getElementById('create-account-form').addEventListener('submit', handleCreateAccount)
      document.getElementById('add-todo-form').addEventListener('submit', addTodoHandler)
      document.getElementById('logout-button').addEventListener('click', handleLogout)

      document.getElementById('todo-view').style.display = 'none'
      document.getElementById('auth-view').style.display = 'none'

      userbase.signInWithSession()
        .then((session) => showTodos(session.username))
        .catch(() => showAuth())
        .then(() => document.getElementById('init-view').style.display = 'none')

    </script>
  </body>
</html>
